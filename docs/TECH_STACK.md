# ECHO — Tech Stack

> This document defines the technology choices for ECHO. All implementation phases, architecture decisions, and code generation should reference this file as the authoritative source for stack conventions.

---

## Table of Contents

1. [Stack Overview](#1-stack-overview)
2. [Frontend](#2-frontend)
3. [Backend & Database](#3-backend--database)
4. [API Layer](#4-api-layer)
5. [Authentication & Authorization](#5-authentication--authorization)
6. [File & Media Storage](#6-file--media-storage)
7. [AI & Machine Learning](#7-ai--machine-learning)
8. [Notifications & Messaging](#8-notifications--messaging)
9. [Deployment & Infrastructure](#9-deployment--infrastructure)
10. [Development Tooling](#10-development-tooling)
11. [Third-Party Integrations](#11-third-party-integrations)
12. [Architecture Diagram](#12-architecture-diagram)
13. [Key Conventions](#13-key-conventions)

---

## 1. Stack Overview

| Layer | Technology | Purpose |
|---|---|---|
| Frontend Framework | Next.js 16 (App Router) | SSR for public website, CSR for dashboard |
| Language | TypeScript | Type safety across frontend and backend |
| Styling | Tailwind CSS | Utility-first, consistent design system |
| UI Components | shadcn/ui (Radix primitives) | Accessible, customizable component library |
| Database | PostgreSQL (via Supabase) | Relational data for all 29+ tables |
| Vector Store | pgvector (via Supabase) | Embeddings for AI/RAG features |
| ORM | Prisma | Type-safe database access, migrations, schema management |
| Auth | Supabase Auth | Email/password, Google OAuth, 2FA |
| File Storage | Supabase Storage | Photos, agreements, media files with CDN |
| Real-time | Supabase Realtime | Live updates for listings, notifications, collaboration |
| Edge Functions | Supabase Edge Functions | Webhooks, scheduled tasks, background processing |
| AI | Claude API (Anthropic) | RAG chatbot, report generation, autofill, agent assistant |
| Email | Resend | Transactional emails, report delivery |
| LINE | LINE Notify API | Thai market notifications and report delivery |
| PDF Generation | react-pdf | Marketing reports, listing comparisons |
| Hosting (Frontend) | Vercel | Next.js deployment, edge functions, preview URLs |
| Hosting (Backend) | Supabase Cloud | Database, auth, storage, realtime, edge functions |

---

## 2. Frontend

### 2.1 Next.js (App Router)

ECHO requires two fundamentally different rendering strategies within one application:

- **Agent Dashboard** (authenticated) — Rich, interactive, client-heavy. Tables with inline editing, drag-and-drop, real-time updates, complex filters. Rendered client-side.
- **Public Website** (visitor-facing) — SEO-critical, fast initial load, content-driven. Listing pages, blog, about page. Server-side rendered.

Next.js App Router handles both natively with React Server Components (RSC) for public pages and client components for the dashboard. This eliminates the need for two separate applications.

**Version:** Next.js 16 with App Router (not Pages Router).

**Routing structure:**

```
/app
  /(public)              → Public website (SSR)
    /page.tsx            → Homepage
    /listings/page.tsx   → Listing search
    /listings/[id]/page.tsx → Listing detail
    /about/page.tsx      → About / team
    /blog/page.tsx       → Blog index
    /blog/[slug]/page.tsx → Blog post
    /contact/page.tsx    → Contact form
  /(dashboard)           → Agent dashboard (CSR, authenticated)
    /dashboard/page.tsx  → Dashboard home
    /listings/page.tsx   → Listing management table
    /crm/page.tsx        → CRM (deals + contacts)
    /projects/page.tsx   → Project database
    /website/page.tsx    → Website builder
    /ai/page.tsx         → AI chat interface
    /settings/page.tsx   → Workspace settings
  /api                   → API routes
```

### 2.2 TypeScript

All code — frontend and backend — is written in TypeScript with strict mode enabled. This is non-negotiable for a codebase that will be generated by AI tools and later maintained by human developers.

**tsconfig.json strict settings:**
```json
{
  "compilerOptions": {
    "strict": true,
    "noUncheckedIndexedAccess": true,
    "forceConsistentCasingInFileNames": true
  }
}
```

### 2.3 Tailwind CSS

Utility-first CSS framework. No custom CSS files unless absolutely necessary. All spacing, colors, typography, and responsive breakpoints use Tailwind utilities.

**Custom theme extensions** in `tailwind.config.ts`:
- Workspace branding colors (primary, secondary) loaded dynamically per workspace.
- Real estate-specific color tokens for status indicators (Active = green, Sold = blue, Expired = red, etc.).

### 2.4 shadcn/ui

Component library built on Radix UI primitives + Tailwind. Components are copied into the project (not installed as a dependency), giving full ownership and customization control.

**Key components ECHO will use heavily:**
- `DataTable` — Listing table, CRM table (with inline editing extensions)
- `Dialog` / `Sheet` — Detail views, confirmation dialogs, quick-create forms
- `Command` — Global search (Cmd+K)
- `Select` / `MultiSelect` — Filter dropdowns, tag selectors
- `Tabs` — Buyer/Seller CRM tabs
- `Badge` — Status indicators, potential tier labels
- `Toast` (via **Sonner**) — Action confirmations, error messages. ECHO uses the `sonner` library instead of shadcn's built-in toast.
- `Calendar` / `DatePicker` — Reminder dates, timeline filters
- `DropdownMenu` — Row actions, bulk actions

**Additional UI libraries:**
- `@dnd-kit/core` — Drag-and-drop for photo ordering, website section arrangement, pipeline stage reordering.
- `@tanstack/react-table` — Headless table logic for the listing and CRM tables (sorting, filtering, grouping, column resizing, virtualization).
- `react-hook-form` + `zod` — Form management and validation across all create/edit forms.

---

## 3. Backend & Database

### 3.1 Supabase (PostgreSQL)

Supabase provides the entire backend infrastructure: database, auth, storage, real-time subscriptions, and edge functions. The underlying database is standard PostgreSQL, which means zero vendor lock-in on the data layer.

**Why Supabase over a custom backend:**

| Capability | Supabase provides | Custom alternative effort |
|---|---|---|
| Auth + OAuth + 2FA | Built-in | 2–3 weeks |
| Row Level Security | Policy-based, per-table | Custom middleware per endpoint |
| Real-time subscriptions | WebSocket channels, per-table | Custom WebSocket server |
| File storage + CDN | Supabase Storage | S3 + CloudFront setup |
| Auto-generated REST API | PostgREST | Manual API routes |
| Database migrations | Supabase CLI | Manual migration tooling |
| Edge Functions | Deno-based serverless functions | Lambda / Cloud Functions setup |
| Vector search | pgvector extension | Separate vector DB (Pinecone, etc.) |

**Supabase project structure:**
```
/supabase
  /migrations        → SQL migration files (version-controlled)
  /functions          → Edge Functions (Deno/TypeScript)
  config.toml         → Supabase project configuration
```
*Note: Seed data is managed via `prisma/seed.ts` (TypeScript) rather than Supabase's native `seed.sql`. This ensures Type-Safety and accurate database column mapping.*

### 3.2 PostgreSQL Schema Conventions

- All table and column names use `snake_case`.
- All tables include `id` (UUID, primary key, default `gen_random_uuid()`).
- All tables include `created_at` (timestamptz, default `now()`).
- All tables include `workspace_id` (FK) for multi-tenancy isolation.
- Soft deletes use an `archived` boolean column (never hard delete user data).
- JSON columns use `jsonb` type.
- Multi-value fields (tags, preferences) use PostgreSQL arrays or junction tables depending on query needs.
- All foreign keys have appropriate `ON DELETE` behavior defined (CASCADE, SET NULL, or RESTRICT).

### 3.3 pgvector

The `pgvector` extension is enabled in Supabase for AI features. Used to store and query embeddings for:

- Listing data (for semantic search and smart matching).
- Contact requirements (for buyer-listing matching).
- AI chatbot context retrieval (RAG).

Embeddings are generated via the Claude/OpenAI embeddings API and stored alongside the source records.

---

## 4. API Layer

ECHO uses a hybrid API approach:

### 4.1 Supabase Client SDK (Direct Access)

For straightforward CRUD operations where Row Level Security (RLS) is sufficient:
- Reading/writing listings, contacts, deals, comments.
- Real-time subscriptions for live updates.
- File uploads to Supabase Storage.
- Auth operations (login, signup, session management).

The Supabase JS client is used directly from Next.js client components and server components.

### 4.2 Next.js Server Actions (Primary Mutation Pattern)

ECHO uses **Next.js Server Actions** (`"use server"` directive) as the primary pattern for dashboard CRUD operations. Server Actions co-locate with their page routes (e.g., `settings/actions.ts`, `settings/pipeline-actions.ts`) and are called directly from client components without needing a separate API endpoint.

Server Actions are used for:
- Workspace settings CRUD (name, branding, team management).
- Pipeline stage and potential tier management.
- Team invitations (invite, revoke).
- Playbook action management.

### 4.2.1 Next.js API Routes (Complex Logic)

For operations that are more complex or triggered externally, traditional API routes are used:
- Smart matching (calculating match scores between listings and buyer contacts).
- Pipeline stage transitions (with validation, history logging, and notification triggers).
- Report generation (AI + PDF rendering).
- Data import/export (Excel/CSV parsing and generation).
- Webhook endpoints (for LINE, external portals).
- Scheduled tasks triggered by cron (via Vercel Cron or Supabase pg_cron).

### 4.3 Prisma ORM

Prisma is used within Next.js API routes for complex queries that benefit from type safety and join optimization:
- Dashboard aggregations (deal counts by stage, listing metrics, conversion rates).
- Smart matching queries (multi-field comparisons across listings and contacts).
- Audit log queries.
- Any query joining 3+ tables.

**Prisma schema** is the single source of truth for the database structure. Supabase migrations are generated from Prisma schema changes.

```
/prisma
  schema.prisma       → Full database schema (29+ models)
  seed.ts             → TypeScript seed script
  prisma.config.ts    → Prisma configuration (required for CLI in v6.19.2)
```

**⚠️ CRITICAL PRISMA CONFIGURATION (v6.19.2) NOTE:**
- **Version Lock:** The project is locked to **Prisma v6.19.2**. Do not upgrade to Prisma 7, as Prisma 7 fundamentally changes how `PrismaClient` connects to Supabase database poolers and breaks standard standalone scripts.
- **Datasource URLs:** `DATABASE_URL` and `DIRECT_URL` must be declared directly in `schema.prisma` using `env()`.
- **Seeding & Typing:** The `prisma/seed.ts` script must strictly use the **Prisma schema field names**, NOT the underlying database column names. For example, if a schema uses `pipelineStageName String @map("pipeline_stage_name")`, the TypeScript seed object must use `pipelineStageName`, or validation will fail.

### 4.4 API Route Organization

```
/app/api
  /auth               → Custom auth logic (if needed beyond Supabase)
  /listings
    /route.ts          → CRUD, bulk operations
    /[id]/route.ts     → Single listing operations
    /import/route.ts   → Excel/CSV import
    /export/route.ts   → Excel/CSV/PDF export
  /contacts
    /route.ts
    /[id]/route.ts
    /duplicates/route.ts → Duplicate detection
  /deals
    /route.ts
    /[id]/route.ts
    /[id]/stage/route.ts → Pipeline stage transitions
  /projects
    /route.ts
    /[id]/route.ts
  /ai
    /chat/route.ts      → RAG chatbot
    /autofill/route.ts  → Data input autofill
    /report/route.ts    → Report generation
    /assistant/route.ts → Agent assistant suggestions
  /notifications
    /route.ts
    /line/route.ts      → LINE Notify dispatch
    /email/route.ts     → Email dispatch
  /webhooks
    /line/route.ts      → LINE incoming webhooks
    /forms/route.ts     → Website form submissions
  /media
    /upload/route.ts
    /watermark/route.ts
  /settings
    /workspace/route.ts
    /pipeline/route.ts
    /potential/route.ts
    /playbook/route.ts
```

---

## 5. Authentication & Authorization

### 5.1 Supabase Auth

- **Email + password** sign-up and login.
- **Google OAuth** social login.
- **Two-factor authentication (2FA)** via TOTP (authenticator app).
- **Session management** via Supabase's JWT-based sessions, refreshed automatically.
- **Password reset** via email.

### 5.2 Role-Based Access Control (RBAC)

Roles are defined per user per workspace:

| Role | Listings | CRM | Settings | Website Builder | AI |
|---|---|---|---|---|---|
| Owner | Full access | Full access | Full access | Full access | Full access |
| Admin | Full access | Full access | Full access | Full access | Full access |
| Co-Worker | Read/write own | Read/write own | Read only | No access | Full access |
| Listing Support | Read/write listings only | No access | No access | No access | No access |

**Implementation:** Supabase Row Level Security (RLS) policies enforce access at the database level. Each table has RLS policies that check the user's role from the JWT and filter/restrict rows accordingly. This means access control is enforced even if the API layer has a bug.

**⚠️ CRITICAL RLS IMPLEMENTATION NOTE:**
When generating bulk RLS policies (e.g., a SQL `DO`/`FOR` loop to enforce `workspace_id` isolation), **always verify that the target tables actually contain a `workspace_id` column.** Global tables (like `zones`) or relational mapping tables may not have this column, resulting in `column "workspace_id" does not exist` SQL errors during migrations. Either exclude these tables manually or write a dynamic SQL query that strictly checks `information_schema.columns` before generating the policy.

### 5.3 Multi-Tenancy

All data is scoped by `workspace_id`. RLS policies on every table ensure users can only access data within their workspace. A user can belong to multiple workspaces and switch between them.

---

## 6. File & Media Storage

### 6.1 Supabase Storage

- **Bucket: `listings`** — Unit photos, floor plans, media files. Organized by `workspace_id/listing_id/`.
- **Bucket: `agreements`** — Exclusive agreement PDFs. Private, accessible only by workspace members.
- **Bucket: `avatars`** — User profile photos.
- **Bucket: `website`** — Website builder assets (custom images, blog images).
- **Bucket: `reports`** — Generated AI report PDFs.

### 6.2 Media Processing

- **Watermarking** — Applied server-side via a Supabase Edge Function or Next.js API route using `sharp` (image processing library). Watermarked versions are stored alongside originals.
- **Image optimization** — Next.js `<Image>` component with automatic WebP conversion and responsive sizing for the public website.
- **Upload limits** — Configurable per workspace plan tier.

---

## 7. AI & Machine Learning

### 7.1 LLM Provider — Claude API (Anthropic)

Primary LLM for all AI features. Model: `claude-sonnet-4-5-20250929` for cost-efficient general tasks, `claude-opus-4-6` for complex reasoning tasks (agent assistant analysis).

### 7.2 Embeddings

Embeddings generated via the Anthropic or OpenAI embeddings API. Stored in PostgreSQL using the `pgvector` extension. Used for:
- Semantic search across listings.
- Buyer-listing smart matching.
- RAG context retrieval for the chatbot.

### 7.3 Feature Implementation Patterns

| AI Feature | Pattern |
|---|---|
| **RAG Chatbot** | User query → embed query → pgvector similarity search for relevant records → inject context into Claude prompt → return answer with source references. |
| **Marketing Report** | User selects fields/stats → API aggregates data from Listings/Deals tables → Claude generates narrative commentary → react-pdf renders final PDF. |
| **Listing Comparison** | User selects listings → API fetches listing data → Claude generates comparison analysis → react-pdf renders side-by-side PDF. |
| **Data Input Autofill** | User pastes raw text → Claude parses and returns structured JSON mapped to listing schema fields → frontend pre-fills the create listing form → user reviews and saves. |
| **Agent Assistant** | Scheduled analysis (daily/weekly) → queries workspace data for overdue actions, stale listings, stuck deals → Claude generates prioritized suggestions → surfaced as notifications and/or in AI chat. |

### 7.4 AI Cost Management

- Cache common queries and their embeddings to reduce API calls.
- Use the lighter model (Sonnet) for routine tasks (autofill, simple Q&A).
- Reserve the heavier model (Opus) for complex analysis (agent assistant, market insights).
- Token usage tracked per workspace for future billing/plan tier enforcement.

---

## 8. Notifications & Messaging

### 8.1 LINE Notify

- **Setup:** Workspace owner authenticates via LINE Notify OAuth to generate a token, stored in the Workspace table.
- **Use cases:** Action reminders, deal stage changes, new form submissions, report delivery.
- **Implementation:** API calls from Next.js API routes or Supabase Edge Functions to the LINE Notify API.

### 8.2 LINE Official Account Integration

- For two-way messaging with clients (beyond one-way LINE Notify).
- Webhook receiver in Next.js API route to capture incoming messages.
- Future phase — enables conversational workflows with clients.

### 8.3 Email — Resend

- **Transactional emails:** Action reminders, report delivery, team invitations, password reset.
- **Templates:** React Email templates (JSX-based, consistent with the rest of the stack).
- **Domain:** Custom sending domain configured per workspace for professional delivery.

### 8.4 In-App Notifications

- Stored in the Notification table.
- Delivered in real-time via Supabase Realtime subscriptions.
- Notification bell in the dashboard header with unread count.
- Mark as read, mark all as read, click to navigate to the relevant entity.

---

## 9. Deployment & Infrastructure

### 9.1 Vercel (Frontend + API Routes)

- **Auto-deploy** from the main Git branch.
- **Preview deployments** for every pull request — Antigravity and future devs can test changes before merging.
- **Edge Functions** for geo-optimized routing (Thailand-first, but globally accessible).
- **Cron Jobs** via Vercel Cron for scheduled tasks (daily AI assistant analysis, overdue reminder checks).
- **Environment variables** for all secrets (Supabase keys, Claude API key, LINE tokens, Resend key).

### 9.2 Supabase Cloud (Backend)

- **Region:** Seoul (`ap-northeast-2`).
- **Database backups:** Automatic daily backups via Supabase.
- **Connection pooling:** Supavisor for handling concurrent connections.

### 9.3 Environments

| Environment | Purpose | Hosting |
|---|---|---|
| Local | Development | `next dev` + Supabase CLI (local) |
| Preview | PR testing | Vercel Preview + Supabase branch (or staging project) |
| Staging | Pre-production testing | Vercel + Supabase staging project |
| Production | Live application | Vercel + Supabase production project |

### 9.4 Domain Structure

```
app.echo.co.th          → Agent dashboard (authenticated)
*.echo.co.th            → Agent public websites (wildcard subdomain)
                           OR custom domains mapped per workspace
api.echo.co.th          → API (proxied to Vercel)
```

---

## 10. Development Tooling

### 10.1 Code Quality

| Tool | Purpose |
|---|---|
| ESLint | Code linting (Next.js + TypeScript config) |
| Prettier | Code formatting |
| Husky + lint-staged | Pre-commit hooks to enforce linting and formatting |
| TypeScript strict mode | Compile-time type checking |

### 10.2 Testing

| Tool | Purpose |
|---|---|
| Vitest | Unit testing (faster than Jest, native TypeScript) |
| Playwright | End-to-end testing (browser automation) |
| Prisma Studio | Visual database inspection during development |

### 10.3 Version Control

- **Git** with conventional commits.
- **Branch strategy:** `main` (production), `staging`, feature branches (`feat/listing-table`, `fix/crm-filter`).
- AI-generated code should always go through a branch → PR → review → merge workflow, even if you're the only reviewer.

### 10.4 Monorepo Structure

```
/echo
  /app                   → Next.js application (App Router)
    /(public)            → Public website pages
    /(dashboard)         → Dashboard pages
    /api                 → API routes
  /components            → Shared React components
    /ui                  → shadcn/ui components
    /listings            → Listing-specific components
    /crm                 → CRM-specific components
    /website-builder     → Website builder components
    /ai                  → AI chat and report components
    /shared              → Layout, navigation, common components
  /lib                   → Shared utilities
    /supabase.ts         → Supabase client initialization
    /prisma.ts           → Prisma client initialization
    /ai.ts               → Claude API client
    /line.ts             → LINE Notify client
    /email.ts            → Resend client
    /utils.ts            → General utilities
    /validations         → Zod schemas for all entities
  /hooks                 → Custom React hooks
  /stores                → Client-side state (Zustand or React Context)
  /types                 → Shared TypeScript type definitions
  /prisma
    schema.prisma        → Database schema
  /supabase
    /migrations          → SQL migrations
    /functions           → Edge Functions
    /seed.sql            → Default data
  /public                → Static assets
  /docs
    PRODUCT_SPEC.md
    TECH_STACK.md
    IMPLEMENTATION_PLAN.md
  package.json
  tailwind.config.ts
  tsconfig.json
  .env.local             → Local environment variables (not committed)
```

---

## 11. Third-Party Integrations

| Integration | Library / Method | Purpose |
|---|---|---|
| Google OAuth | Supabase Auth (built-in provider) | Social login |
| LINE Notify | REST API (direct HTTP calls) | Notifications to agents |
| LINE Official Account | LINE Messaging API + Webhook | Two-way client communication |
| Resend | `resend` npm package | Transactional email |
| Claude API | `@anthropic-ai/sdk` npm package | All AI features |
| Excel/CSV Import | `xlsx` (SheetJS) npm package | Data import |
| Excel/CSV Export | `xlsx` (SheetJS) npm package | Data export |
| PDF Generation | `@react-pdf/renderer` npm package | Marketing reports, comparison reports |
| Google Maps | `@react-google-maps/api` npm package | Map-based listing search, location display |
| Ddproperty / Livinginsider | REST API or scraping (Coming Soon) | Portal listing sync |

---

## 12. Architecture Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                        CLIENTS                               │
│  Browser (Dashboard)  │  Browser (Public Website)  │  Mobile │
└────────────┬──────────┴──────────────┬─────────────┴────────┘
             │                         │
             ▼                         ▼
┌─────────────────────────────────────────────────────────────┐
│                      VERCEL                                  │
│                                                              │
│  ┌─────────────────┐  ┌──────────────────┐                  │
│  │  Next.js App     │  │  API Routes       │                 │
│  │  (App Router)    │  │  /api/*           │                 │
│  │                  │  │                   │                  │
│  │  Dashboard (CSR) │  │  Business Logic   │                 │
│  │  Website (SSR)   │  │  AI Endpoints     │                 │
│  │                  │  │  Import/Export    │                  │
│  └────────┬─────────┘  └───────┬──────────┘                 │
│           │                     │                             │
│  ┌────────┴─────────────────────┴──────────┐                │
│  │            Prisma ORM                    │                │
│  └────────────────────┬─────────────────────┘                │
│                       │  Vercel Cron (scheduled tasks)       │
└───────────────────────┼──────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                     SUPABASE CLOUD                           │
│                                                              │
│  ┌──────────┐  ┌──────────┐  ┌───────────┐  ┌────────────┐ │
│  │PostgreSQL │  │ Auth     │  │ Storage   │  │ Realtime   │ │
│  │+ pgvector │  │(JWT,OAuth│  │(CDN,      │  │(WebSocket  │ │
│  │          │  │ 2FA)     │  │ Buckets)  │  │ channels)  │ │
│  └──────────┘  └──────────┘  └───────────┘  └────────────┘ │
│  ┌──────────────────┐  ┌─────────────┐                      │
│  │ Edge Functions    │  │ Row Level   │                      │
│  │ (webhooks,       │  │ Security    │                      │
│  │  background jobs)│  │ (RBAC)      │                      │
│  └──────────────────┘  └─────────────┘                      │
└─────────────────────────────────────────────────────────────┘
                        │
          ┌─────────────┼─────────────┐
          ▼             ▼             ▼
┌──────────────┐ ┌────────────┐ ┌──────────┐
│ Claude API   │ │ LINE APIs  │ │ Resend   │
│ (Anthropic)  │ │ (Notify +  │ │ (Email)  │
│              │ │  Messaging)│ │          │
└──────────────┘ └────────────┘ └──────────┘
```

---

## 13. Key Conventions

These conventions ensure consistency across all code, whether written by AI tools or human developers.

### 13.1 Naming

| Context | Convention | Example |
|---|---|---|
| Database tables | snake_case, plural | `listings`, `pipeline_stages` |
| Database columns | snake_case | `created_at`, `workspace_id` |
| TypeScript types/interfaces | PascalCase | `Listing`, `PipelineStage` |
| React components | PascalCase | `ListingTable`, `DealCard` |
| Functions/variables | camelCase | `getListings`, `dealCount` |
| API routes | kebab-case | `/api/listings/bulk-update` |
| CSS classes | Tailwind utilities only | `className="flex items-center gap-2"` |
| Environment variables | UPPER_SNAKE_CASE | `SUPABASE_URL`, `CLAUDE_API_KEY` |

### 13.2 File Organization

- One React component per file.
- Co-locate component-specific hooks, types, and utilities with the component.
- Shared utilities go in `/lib`.
- Shared types go in `/types`.
- Validation schemas (Zod) go in `/lib/validations` and are shared between frontend forms and API routes.

### 13.3 Error Handling

- API routes return consistent error responses: `{ error: string, code: string, details?: any }`.
- Frontend uses **Sonner** toast notifications for user-facing errors and confirmations.
- All Supabase and Prisma calls are wrapped in try/catch with appropriate error logging.
- Never expose internal error details to the client in production.

### 13.4 State Management

- **Server state:** Supabase client SDK with React Query (`@tanstack/react-query`) for caching, refetching, and optimistic updates.
- **Client state:** Zustand for lightweight UI state (sidebar open/closed, active filters, column configuration).
- **Form state:** react-hook-form + Zod for all forms.
- **URL state:** Next.js `searchParams` for filter states that should be shareable/bookmarkable.

### 13.5 Security Checklist

- All API routes validate input with Zod before processing.
- All database queries go through Prisma (parameterized) or Supabase client (parameterized) — never raw string concatenation.
- RLS policies on every table — no exceptions.
- File uploads validated for type and size before storage.
- CORS configured to allow only the application domain.
- Rate limiting on AI endpoints and auth endpoints.
- Sensitive data (API keys, tokens) stored in environment variables only.
- PDPA compliance: data export, data deletion, and consent tracking capabilities.

---

*This document should be updated whenever a technology decision changes. All implementation work should reference this file to ensure stack consistency across phases.*
